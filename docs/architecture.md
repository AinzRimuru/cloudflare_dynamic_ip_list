# 系统架构设计

## 概述

Cloudflare Worker 动态 IP 白名单系统是一个无服务器应用，用于自动管理 Cloudflare Access Policy 的 IP 白名单。

---

## 系统架构图

```
┌─────────────────────────────────────────────────────────────────────┐
│                           Client Layer                               │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐               │
│  │   iPhone     │  │   Android    │  │  Other Device│               │
│  │  快捷指令     │  │   Tasker     │  │   Cron Job   │               │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘               │
└─────────┼─────────────────┼─────────────────┼───────────────────────┘
          │                 │                 │
          │                 │                 │
          └─────────────────┴─────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────────────┐
│                        Cloudflare Edge                               │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │                     Cloudflare Worker                        │   │
│  │  ┌─────────────────────────────────────────────────────┐    │   │
│  │  │              IP Update + Expire Check               │    │   │
│  │  └─────────────────────────────────────────────────────┘    │   │
│  │                           │                                  │   │
│  └───────────────────────────┼──────────────────────────────────┘   │
│                              │                                       │
├──────────────────────────────┼───────────────────────────────────────┤
│                              ▼                                       │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │                    Cloudflare KV Storage                     │   │
│  │  ┌─────────────────────────────────────────────────────┐   │   │
│  │  │  Key: IP Address    Value: Timestamp (Unix epoch)   │   │   │
│  │  │  ┌────────────────┬─────────────────────────────┐   │   │   │
│  │  │  │ 1.2.3.4        │ 1705317000000                │   │   │   │
│  │  │  │ 5.6.7.8        │ 1705318800000                │   │   │   │
│  │  │  └────────────────┴─────────────────────────────┘   │   │   │
│  │  └─────────────────────────────────────────────────────┘   │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                              │                                       │
├──────────────────────────────┼───────────────────────────────────────┤
│                              ▼                                       │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │                 Cloudflare Gateway List                      │   │
│  │  ┌─────────────────────────────────────────────────────┐   │   │
│  │  │  Name: Dynamic IP Whitelist                          │   │   │
│  │  │  Type: IP                                             │   │   │
│  │  │  Items: 1.2.3.4, 5.6.7.8                              │   │   │
│  │  └─────────────────────────────────────────────────────┘   │   │
│  └─────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────────┐
│                        Zero Trust Access                             │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │                     Access Policy                            │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐  │   │
│  │  │   Action:   │  │   Selector: │  │      Value:          │  │   │
│  │  │   Allow     │  │   IP List   │  │  Dynamic Whitelist   │  │   │
│  │  └─────────────┘  └─────────────┘  └─────────────────────┘  │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                              │                                       │
│                              ▼                                       │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │                       Protected Apps                         │   │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────────┐  │   │
│  │  │    HA Web    │  │  Nextcloud   │  │   Other Apps     │  │   │
│  │  └──────────────┘  └──────────────┘  └──────────────────┘  │   │
│  └─────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 数据流图

### 注册流程

```
┌─────────┐     POST /     ┌──────────────┐     Verify     ┌──────────────┐
│ Client  │──────────────▶│ Cloudflare   │───────────────▶│ Service       │
│  App    │  + CF-Access  │ Access       │    Token       │ Token Valid?  │
└─────────┘     Headers    └──────┬───────┘               └──────┬───────┘
                              │                               │
                              │ No                            │ Yes
                              ▼                               │
                      ┌─────────────┐                         │
                      │ Return 403  │                         │
                      └─────────────┘                         ▼
                                                        ┌─────────────┐
                                                        │ Get Client  │
                                                        │     IP      │
                                                        └──────┬──────┘
                                                         │
                        ┌────────────────────────────────┴────────┐
                        │                                         │
                        ▼                                         ▼
                ┌───────────────┐                       ┌───────────────┐
                │ Store to KV   │                       │  Sync to      │
                │  IP + Now     │                       │  Cloudflare   │
                └───────┬───────┘                       │     List     │
                        │                               └───────┬───────┘
                        │                                       │
                        ▼                                       │
                ┌───────────────┐                               │
                │ Scan all IPs   │                               │
                │ Delete expired │                               │
                └───────────────┘                               │
                        │                                       │
                        └───────────────────┬───────────────────┘
                                            ▼
                                    ┌───────────────┐
                                    │ Return 200 OK │
                                    │ + IP Address  │
                                    └───────────────┘
```

---

## 核心组件

### 1. Worker (应用层)

**职责：**
- 接收客户端请求（已通过 Access 认证）
- 提取客户端 IP
- 协调各模块执行
- 返回响应

**注意：** 认证由 Cloudflare Access 在边缘层处理，Worker 只接收已授权的请求。

### 2. IP Update Module (IP 更新模块)

**职责：**
- 获取客户端真实 IP
- 更新 KV 存储时间戳
- 触发过期检查

### 3. Expire Check Module (过期检查模块)

**职责：**
- 遍历 KV 所有键
- 计算时间差
- 删除过期条目
- 构建有效 IP 列表

### 4. KV Storage (存储层)

**数据结构：**
```
Key:   "1.2.3.4" (IP 地址)
Value: "1705317000000" (Unix 时间戳)
```

**特点：**
- 全球分布式
- 低延迟读取
- 事件一致性

### 5. Cloudflare List (同步目标)

**用途：**
- 被 Access Policy 引用
- 实时生效
- 支持最大 1000 条目

---

## 时序图

```
Client          Worker           KV              Cloudflare API
  │               │                │                    │
  │──── POST ────▶│                │                    │
  │   + Token     │                │                    │
  │               │                │                    │
  │               │── Verify Token▶│                    │
  │               │◀──── Valid ────│                    │
  │               │                │                    │
  │               │── Get IP ─────▶│                    │
  │               │◀─ 1.2.3.4 ─────│                    │
  │               │                │                    │
  │               │── Put KV ─────▶│                    │
  │               │   IP+Now       │                    │
  │               │◀───────────────│                    │
  │               │                │                    │
  │               │── List Keys ──▶│                    │
  │               │◀─ [All IPs] ───│                    │
  │               │                │                    │
  │               │── Check Expire▶│                    │
  │               │◀───────────────│                    │
  │               │                │                    │
  │               │── Delete Old ─▶│                    │
  │               │◀───────────────│                    │
  │               │                │                    │
  │               │──── PUT /lists ────────────────────▶│
  │               │        [Valid IPs]                 │
  │               │◀────────────────────────────────────│
  │               │                │                    │
  │◀─ 200 OK ─────│                │                    │
  │   + IP        │                │                    │
```

---

## 安全设计

### 1. 认证

- Cloudflare Access Service Token 认证
- 认证在边缘层完成，未授权请求无法到达 Worker
- 支持 Token 轮换

### 2. 授权

- API Token 最小权限原则
- 仅授予 Gateway List Edit 权限

### 3. 数据保护

- KV 存储不记录敏感信息
- 仅存储 IP + 时间戳
- 日志脱敏

### 4. 网络安全

- 全程 HTTPS
- Cloudflare DDoS 保护
- IP 伪造防护 (CF-Connecting-IP)

---

## 扩展性考虑

### 横向扩展

- Worker 无状态设计
- KV 支持高并发
- 自动弹性伸缩

### 功能扩展

| 功能 | 实现方式 |
|------|---------|
| 用户分组 | KV value 存储 JSON |
| 速率限制 | KV 计数器 + TTL |
| 通知 | 集成邮件/Webhook |
| 审计日志 | 追踪所有变更到 KV |
